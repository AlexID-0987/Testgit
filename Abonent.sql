 use Abonent

CREATE TABLE Orders
(

	Id int not null identity primary key,
    CustomerId nvarchar (max),
    OrderDate date NOT NULL,
    OrderId nvarchar (max)  NOT NULL,
    SumOrd money,
    
);
INSERT INTO Orders 
VALUES ('288ABF50-8A85-406B-ABFB-F67F978FF321',	'10/8/2018',	'5FBC90E8-DB53-47E0-814A-997D6183B1B7',	315.00),
('050ABAD7-8829-449B-8523-FB062CD988E5',	'10/22/2018',	'421A66D7-50EC-4EE8-A90F-3071D7A095FE',	840),
('050ABAD7-8829-449B-8523-FB062CD988E5',	'11/9/2018',	'B2BBB039-C479-4963-A610-AAEB1BB9AED0',	228),
('050ABAD7-8829-449B-8523-FB062CD988E5',	'11/13/2018',	'B6036023-3E0F-4310-BDDC-5607805633F2',	840),
('050ABAD7-8829-449B-8523-FB062CD988E5',	'11/29/2018',	'1E67720B-0F2B-467E-B4E1-AE94E78D1864',	228),
('050ABAD7-8829-449B-8523-FB062CD988E5',	'12/7/2018',	'88D2F09E-FD52-4341-9A2F-E3F3F14DEAAF',	840),
('050ABAD7-8829-449B-8523-FB062CD988E5',	'12/21/2018',	'48768DA4-5F9C-4C11-889F-4D41BD2555C3',	840),
('050ABAD7-8829-449B-8523-FB062CD988E5',	'12/24/2018',	'ADB6B0ED-1978-415A-801A-48FA8AF40B10',	228),
('050ABAD7-8829-449B-8523-FB062CD988E5',	'1/15/2019',	'EDB5DF36-69C0-412B-892F-F36373529F01',	1008),
('288ABF50-8A85-406B-ABFB-F67F978FF321',	'10/8/2018',	'5FBC90E8-DB53-47E0-814A-997D6183B1B7',	315),
('288ABF50-8A85-406B-ABFB-F67F978FF321',	'10/19/2018',	'0B8B6865-EE64-41AA-9BE5-6F5BEA9DDCB1',	306),
('288ABF50-8A85-406B-ABFB-F67F978FF321',	'10/25/2018',	'9BCF13A8-63D8-4735-9D08-58BA728209F8',	315),
('288ABF50-8A85-406B-ABFB-F67F978FF321',	'11/2/2018',	'CA0EE75D-5841-49B0-99CD-9BB911C15CC9',	315),
('288ABF50-8A85-406B-ABFB-F67F978FF321',	'11/15/2018',	'53DCFF68-BEF3-461A-9C95-17E7E51E4B0B',	315),
('288ABF50-8A85-406B-ABFB-F67F978FF321',	'11/27/2018',	'C73C8619-2014-4DA9-8E11-6F2A09C08388',	315),
('288ABF50-8A85-406B-ABFB-F67F978FF321',	'12/10/2018',	'642E8346-119A-418E-BF18-82788DA2953D',	315),
('288ABF50-8A85-406B-ABFB-F67F978FF321',	'12/17/2018',	'84687B59-91F0-48E6-8713-317D0FBDA211',	315),
('288ABF50-8A85-406B-ABFB-F67F978FF321',	'12/27/2018',	'B5C9BE2A-0183-45D2-B82F-5CCA623ED32E',	315),
('288ABF50-8A85-406B-ABFB-F67F978FF321',	'1/9/2019',	'240C4838-474F-4025-B8D8-39AB5E9A72F1',	315),
('F10056B2-4605-4874-9C48-E7FCAA61E9D5',	'10/8/2018',	'84AC9761-5DA0-4BFB-A33D-44E21C4CB97A',	306),
('F10056B2-4605-4874-9C48-E7FCAA61E9D5',	'10/30/2018',	'2564D573-5C1F-4A32-B850-DD696253A758',	204),
('F10056B2-4605-4874-9C48-E7FCAA61E9D5',	'11/16/2018',	'6838B8D4-15FC-45B5-8F1A-4BA82F332668',	306),
('F10056B2-4605-4874-9C48-E7FCAA61E9D5',	'11/23/2018',	'CB1937D9-AC44-4CCE-8544-03B9CB6FC9D1',	228),
('F10056B2-4605-4874-9C48-E7FCAA61E9D5',	'12/4/2018',	'CDACB003-F8DA-4F95-A31B-2A1C68746A2D',	306),
('F10056B2-4605-4874-9C48-E7FCAA61E9D5',	'12/19/2018',	'E40815C0-CCC8-4D27-9953-C33F67E5C741',	315),
('F10056B2-4605-4874-9C48-E7FCAA61E9D5',	'12/20/2018',	'FAF08CC6-A026-4993-B7A1-7CFCA9F5B0E1',	306),
('F10056B2-4605-4874-9C48-E7FCAA61E9D5',	'1/14/2019',	'08060010-99FA-4E0E-8E24-45B5F3ABC58F',	306),
('6F852436-D712-4A37-8B5B-E25C04FDF34A',	'10/2/2018',	'C35DA6C2-BFF9-49D2-83CF-3C2567464AE9',	540),
('6F852436-D712-4A37-8B5B-E25C04FDF34A',	'10/12/2018',	'600DBAD6-7DD1-4114-8EE3-E224B679561D',	360),
('6F852436-D712-4A37-8B5B-E25C04FDF34A',	'10/24/2018',	'673FE052-1ECC-434F-96F0-212401DB583F',	744),
('6F852436-D712-4A37-8B5B-E25C04FDF34A',	'11/5/2018',	'84374437-F2E9-4C23-B34B-C7B7C9723AB5',	372),
('6F852436-D712-4A37-8B5B-E25C04FDF34A',	'11/9/2018',	'5B16A756-3CE8-41FD-A743-4173E6989612',	372),
('6F852436-D712-4A37-8B5B-E25C04FDF34A',	'11/20/2018',	'714CCFC4-247A-4722-87EB-0B2E5AE569BE',	372),
('6F852436-D712-4A37-8B5B-E25C04FDF34A',	'11/30/2018',	'49F87310-90A4-4434-A01D-B3DBCAEA6D73',	540),
('6F852436-D712-4A37-8B5B-E25C04FDF34A',	'12/10/2018',	'591BC0AC-7CAA-4E0F-9CB5-8B41B6F355AF',	279),
('6F852436-D712-4A37-8B5B-E25C04FDF34A',	'12/13/2018',	'F50A502C-FA5F-4EFF-9859-DE86EA3B54F3',	315),
('6F852436-D712-4A37-8B5B-E25C04FDF34A',	'12/21/2018',	'3A8E173F-3857-4C94-A709-D8291F24FFC3',	465),
('6F852436-D712-4A37-8B5B-E25C04FDF34A',	'1/8/2019',	'5633BE69-5512-4274-9D91-DC4E59C7F366',	372),
('03A525A9-822B-4D64-8FE9-E07645756A96',	'10/2/2018',	'51159A33-8BB5-42FA-97AD-8234B0991DD6',	1.350),
('03A525A9-822B-4D64-8FE9-E07645756A96',	'10/5/2018',	'CF6A608A-2D8F-4839-B21A-CD511469C6F4',	1.080),
('03A525A9-822B-4D64-8FE9-E07645756A96',	'10/9/2018',	'826D62AF-8934-4A08-A2BE-F8C97B06432F',	1.080),
('03A525A9-822B-4D64-8FE9-E07645756A96',	'11/23/2018',	'92AA5B7B-57B1-4BA2-BE6C-38926033C08C',	1.188),
('03A525A9-822B-4D64-8FE9-E07645756A96',	'12/18/2018',	'02C5B052-2DAE-4FE4-9175-5E0DA4DA5FDB',	1.134),
('03A525A9-822B-4D64-8FE9-E07645756A96',	'12/21/2018',	'8C2152A7-96B1-4DF0-92E0-892B332CE4F0',	1.080),
('03A525A9-822B-4D64-8FE9-E07645756A96',	'12/25/2018',	'A8A965CA-647F-4834-8F5B-15B1936C7DEC',	1.080),
('03A525A9-822B-4D64-8FE9-E07645756A96',	'1/2/2019',	'F8B55620-8F3C-446D-AC6A-704E5E9904FD',	1.080),
('13C933EB-E2BA-4106-A4C6-D9A591D273A3',	'10/11/2018',	'186D7759-6C7A-4DFF-A7CB-4CDC443267C3',	372),
('13C933EB-E2BA-4106-A4C6-D9A591D273A3',	'10/18/2018',	'DDD949D0-979B-4110-B099-47439A489FD4',	558),
('13C933EB-E2BA-4106-A4C6-D9A591D273A3',	'11/8/2018',	'F9927F95-D43B-44C9-84AD-8B5E17768D20',	372),
('13C933EB-E2BA-4106-A4C6-D9A591D273A3',	'11/22/2018',	'3A24BD9E-0DF5-43C7-B64B-0AD309D7DD44',	558),
('13C933EB-E2BA-4106-A4C6-D9A591D273A3',	'11/29/2018',	'54D4E6F1-63AF-432F-BADC-81A82F459824',	465),
('13C933EB-E2BA-4106-A4C6-D9A591D273A3',	'12/13/2018',	'48907571-B25C-4648-A18B-C73573FAACFE',	744),
('13C933EB-E2BA-4106-A4C6-D9A591D273A3',	'12/27/2018',	'6A3E4C0A-9188-4FF5-9AC1-A6664545A9F3',	372),
('13C933EB-E2BA-4106-A4C6-D9A591D273A3',	'1/10/2019',	'6E6AC041-8770-4761-8136-E13DBBAFF730',	372)

select * from Orders

CREATE TABLE Periodicity
(
    Id INT IDENTITY PRIMARY KEY,
	CustomerId nvarchar (max),
    Days int  NOT NULL,
	Date date not null,
	Date_1 date not null,
	Date_2 date not null,
	Date_3 date not null
);
insert into Periodicity
values('F10056B2-4605-4874-9C48-E7FCAA61E9D5',	19,'04/01/19','04/19/19','04/07/19','04/26/19'),
('050ABAD7-8829-449B-8523-FB062CD988E5',	19,'04/01/19','04/19/19','04/07/19','04/26/19'),
('03A525A9-822B-4D64-8FE9-E07645756A96',	5,'04/01/19',	'04/06/19',	'04/11/19',	'04/16/19'),
('288ABF50-8A85-406B-ABFB-F67F978FF321',	41,'04/01/19'	,'05/15/19',	'06/29/19','08/05/19'),
('13C933EB-E2BA-4106-A4C6-D9A591D273A3',	14,'04/01/19'	,'04/14/19'	,'04/28/19'	,'05/12/19'),
('6F852436-D712-4A37-8B5B-E25C04FDF34A',	10,'04/01/19',	'04/10/19',	'04/20/19',	'04/30/20')

select * from Periodicity

CREATE TABLE Holiday
(
	
    DateH date not null
);

insert into Holiday
Values('12/31/2018'),
('1/1/2019'),
('1/7/2019')
select * from Holiday

CREATE TABLE PaySum
(
	
    CustomerId nvarchar (max),
	Pay money
);

insert into PaySum
values('03A525A9-822B-4D64-8FE9-E07645756A96',	10.000),
('6F852436-D712-4A37-8B5B-E25C04FDF34A',	4.725),
('050ABAD7-8829-449B-8523-FB062CD988E5',	3.600),
('13C933EB-E2BA-4106-A4C6-D9A591D273A3',	3.070),
('F10056B2-4605-4874-9C48-E7FCAA61E9D5',	2.500),
('288ABF50-8A85-406B-ABFB-F67F978FF321',	1.000) 

select * from PaySum

    select distinct O.CustomerId,O.OrderDate,O.OrderId,O.SumOrd,Periodicity.CustomerId,datename(dw,OrderDate) as[Dayweek]
    from Orders as [O],Periodicity,Holiday
    where  OrderDate='12/27/2018' and Periodicity.Date>O.OrderDate and OrderDate!=Holiday.DateH 
	and datename(dw,OrderDate)!='Sunday' and datename(dw,OrderDate)!='Saturday'
	
	select O.CustomerId,O.OrderId,O.SumOrd- sum (P.Pay) as Summa 
    from Orders as O
    join PaySum as P on P.CustomerId =O.CustomerId  Group by P.Pay,P.CustomerId
    union Select OO.CustomerId, OO.OrderId from Orders as OO
    Left Join PaySum as P1 on P1.CustomerId=OO.Id
    where P1.CustomerId is Null 

	